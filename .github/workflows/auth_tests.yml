name: èªè¨¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'lib/services/auth_service.dart'
      - 'lib/screens/auth_screen.dart'
      - 'test/**'
      - 'integration_test/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lib/services/auth_service.dart'
      - 'lib/screens/auth_screen.dart'
      - 'test/**'
      - 'integration_test/**'

env:
  FLUTTER_VERSION: '3.32.5'

jobs:
  unit-and-widget-tests:
    name: å˜ä½“ãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
      run: flutter pub get

    - name: ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ
      run: flutter packages pub run build_runner build --delete-conflicting-outputs

    - name: ã‚³ãƒ¼ãƒ‰è§£æ
      run: flutter analyze

    - name: å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: flutter test test/services/auth_service_test.dart --coverage

    - name: ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: flutter test test/screens/auth_screen_test.dart --coverage

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  integration-tests-android:
    name: Androidçµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    strategy:
      matrix:
        api-level: [29, 33]

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
      run: flutter pub get

    - name: ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ
      run: flutter packages pub run build_runner build --delete-conflicting-outputs

    - name: AVDã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v3
      id: avd-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
        key: avd-${{ matrix.api-level }}

    - name: AVDã‚’ä½œæˆ
      if: steps.avd-cache.outputs.cache-hit != 'true'
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        force-avd-creation: false
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: false
        script: echo "AVDä½œæˆå®Œäº†"

    - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        script: flutter test integration_test/auth_complete_flow_test.dart

  integration-tests-ios:
    name: iOSçµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
      run: flutter pub get

    - name: ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ
      run: flutter packages pub run build_runner build --delete-conflicting-outputs

    - name: iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        xcrun simctl create TestDevice com.apple.CoreSimulator.SimDeviceType.iPhone-14 com.apple.CoreSimulator.SimRuntime.iOS-16-2
        xcrun simctl boot TestDevice

    - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        DEVICE_ID=$(xcrun simctl list devices | grep TestDevice | grep -E -o -i "([0-9a-f]{8}-([0-9a-f]{4}-){3}[0-9a-f]{12})")
        flutter test integration_test/auth_complete_flow_test.dart -d $DEVICE_ID

  test-report:
    name: ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    needs: [unit-and-widget-tests, integration-tests-android, integration-tests-ios]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ä½œæˆ
      run: |
        cat > test_summary.md << EOF
        # èªè¨¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆçµæœ ğŸ§ª

        **å®Ÿè¡Œæ—¥æ™‚**: $(date)
        **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
        **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}

        ## ãƒ†ã‚¹ãƒˆçµæœ

        | ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | çµæœ |
        |-----------|------|
        | å˜ä½“ãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ | ${{ needs.unit-and-widget-tests.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |
        | Androidçµ±åˆãƒ†ã‚¹ãƒˆ | ${{ needs.integration-tests-android.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |
        | iOSçµ±åˆãƒ†ã‚¹ãƒˆ | ${{ needs.integration-tests-ios.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |

        ## æ‰‹å‹•ãƒ†ã‚¹ãƒˆé …ç›®ï¼ˆè¦å®Ÿæ–½ï¼‰

        - [ ] Googleèªè¨¼ãƒ†ã‚¹ãƒˆ
        - [ ] Appleèªè¨¼ãƒ†ã‚¹ãƒˆ
        - [ ] è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é€£æºãƒ†ã‚¹ãƒˆ
        - [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼å¯¾å¿œãƒ†ã‚¹ãƒˆ
        EOF

    - name: ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test_summary.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
