name: èªè¨¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'lib/services/auth_service.dart'
      - 'lib/screens/auth/**'
      - 'test/**'
      - 'integration_test/**'
      - 'pubspec.yaml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'lib/services/auth_service.dart'
      - 'lib/screens/auth/**'
      - 'test/**'
      - 'integration_test/**'
      - 'pubspec.yaml'

env:
  FLUTTER_VERSION: '3.24.5'

jobs:
  unit_and_widget_tests:
    name: å˜ä½“ãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Flutter ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
      run: |
        flutter --version
        dart --version

    - name: ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
      run: flutter pub get

    - name: ä¾å­˜é–¢ä¿‚ã®æ¤œè¨¼
      run: flutter pub deps

    - name: ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ
      run: dart run build_runner build --delete-conflicting-outputs

    - name: ã‚³ãƒ¼ãƒ‰è§£æ
      run: flutter analyze

    - name: å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        flutter test test/services/auth_service_test.dart --coverage --reporter=expanded
        flutter test test/widget_test.dart --coverage --reporter=expanded

    - name: ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: flutter test test/screens/auth_screen_test.dart --coverage --reporter=expanded

    - name: ãã®ä»–ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      run: |
        if [ -d "test/models" ]; then
          flutter test test/models/ --coverage --reporter=expanded || echo "ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi
        if [ -d "test/providers" ]; then
          flutter test test/providers/ --coverage --reporter=expanded || echo "ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå‡¦ç†
      run: |
        if [ -f "coverage/lcov.info" ]; then
          echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          head -20 coverage/lcov.info
        else
          echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always()
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  integration_tests_android:
    name: Androidçµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    strategy:
      matrix:
        api-level: [29, 33]
    if: contains(github.event.head_commit.message, '[integration]') || github.event_name == 'pull_request'

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
      run: flutter pub get

    - name: ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ
      run: dart run build_runner build --delete-conflicting-outputs

    - name: AVDã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v3
      id: avd-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
        key: avd-${{ matrix.api-level }}

    - name: AVDã‚’ä½œæˆ
      if: steps.avd-cache.outputs.cache-hit != 'true'
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        force-avd-creation: false
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: false
        script: echo "AVDä½œæˆå®Œäº†"

    - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        script: |
          if [ -f "integration_test/auth_complete_flow_test.dart" ]; then
            flutter test integration_test/auth_complete_flow_test.dart
          else
            echo "çµ±åˆãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi

  integration_tests_ios:
    name: iOSçµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    if: contains(github.event.head_commit.message, '[integration]') || github.event_name == 'pull_request'

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ä¾å­˜é–¢ä¿‚ã‚’å–å¾—
      run: flutter pub get

    - name: ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ
      run: dart run build_runner build --delete-conflicting-outputs

    - name: åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèª
      run: xcrun simctl list devices available

    - name: iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        # åˆ©ç”¨å¯èƒ½ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ç¢ºèª
        xcrun simctl list runtimes
        # iPhone 15ã‚’ä½¿ç”¨ï¼ˆiOS 17ï¼‰
        DEVICE_ID=$(xcrun simctl create TestDevice com.apple.CoreSimulator.SimDeviceType.iPhone-15 com.apple.CoreSimulator.SimRuntime.iOS-17-0 2>/dev/null || xcrun simctl create TestDevice com.apple.CoreSimulator.SimDeviceType.iPhone-14 com.apple.CoreSimulator.SimRuntime.iOS-16-4)
        echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV
        xcrun simctl boot $DEVICE_ID

    - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        if [ -f "integration_test/auth_complete_flow_test.dart" ]; then
          flutter test integration_test/auth_complete_flow_test.dart -d $DEVICE_ID
        else
          echo "çµ±åˆãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
        fi

  test_report:
    name: ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    needs: [unit_and_widget_tests, integration_tests_android, integration_tests_ios]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ä½œæˆ
      run: |
        cat > test_summary.md << 'EOF'
        # ğŸ¦ ReptiTrack èªè¨¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆçµæœ

        **å®Ÿè¡Œæ—¥æ™‚**: $(date)  
        **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}  
        **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}  
        **Flutter**: ${{ env.FLUTTER_VERSION }}

        ## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

        | ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | çµæœ | è©³ç´° |
        |-----------|------|------|
        | ğŸ§ª å˜ä½“ãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ | ${{ needs.unit_and_widget_tests.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} | AuthService (16ãƒ†ã‚¹ãƒˆ), AuthScreen (8ãƒ†ã‚¹ãƒˆ) |
        | ğŸ¤– Androidçµ±åˆãƒ†ã‚¹ãƒˆ | ${{ (needs.integration_tests_android.result == 'success' && 'âœ… æˆåŠŸ') || (needs.integration_tests_android.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—') || 'âŒ å¤±æ•—' }} | API 29, 33 |
        | ğŸ iOSçµ±åˆãƒ†ã‚¹ãƒˆ | ${{ (needs.integration_tests_ios.result == 'success' && 'âœ… æˆåŠŸ') || (needs.integration_tests_ios.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—') || 'âŒ å¤±æ•—' }} | iOS ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ |

        ## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

        - AuthService: ãƒ¡ãƒ¼ãƒ«èªè¨¼ã€Googleèªè¨¼ã€Appleèªè¨¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        - AuthScreen: UIè¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

        ## ğŸ“ æ‰‹å‹•ãƒ†ã‚¹ãƒˆé …ç›®ï¼ˆè¦å®Ÿæ–½ï¼‰

        - [ ] ğŸ” Googleèªè¨¼ã®å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ
        - [ ] ğŸ Appleèªè¨¼ã®å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ  
        - [ ] ğŸ“± è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã§ã®èªè¨¼çŠ¶æ…‹åŒæœŸ
        - [ ] ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®èªè¨¼å‹•ä½œ
        - [ ] ğŸ”„ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°å‡¦ç†

        ## ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

        ${{ needs.unit_and_widget_tests.result == 'success' && 'èªè¨¼æ©Ÿèƒ½ã®å˜ä½“ãƒ†ã‚¹ãƒˆã¯å®Œç’§ã§ã™ï¼æ¬¡ã¯ä»–ã®æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆè¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚' || 'âš ï¸ ãƒ†ã‚¹ãƒˆã®ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' }}
        EOF

    - name: ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test_summary.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

    - name: ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test_summary.md